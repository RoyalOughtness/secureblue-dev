#!/usr/bin/env bash
set -euo pipefail

# Source the Brew environment
eval "\$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
# Install required brew packages
brew install fzf gum glow

# Ensure we are on signed
RPM_OSTREE_STATUS=$(rpm-ostree status --json --booted)
IMAGE_REF_NAME=$(echo $RPM_OSTREE_STATUS | jq -r '.deployments[0]."container-image-reference" // empty | split("/")[-1]')
rpm-ostree rebase ostree-image-signed:docker://ghcr.io/secureblue/$IMAGE_REF_NAME

# Remove vestigial authselect overrides from Anaconda
cp /usr/etc/authselect/system-auth /etc/authselect/system-auth
cp /usr/etc/authselect/fingerprint-auth /etc/authselect/fingerprint-auth
cp /usr/etc/authselect/dconf-db /etc/authselect/dconf-db
cp /usr/etc/authselect/authselect.conf /etc/authselect/authselect.conf